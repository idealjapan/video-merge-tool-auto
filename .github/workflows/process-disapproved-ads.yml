name: Process Disapproved Ads

on:
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
  
  # å®šæœŸå®Ÿè¡Œï¼ˆ2æ™‚é–“ã”ã¨ï¼‰
  schedule:
    - cron: '0 */2 * * *'  # UTCæ™‚é–“ã§2æ™‚é–“ã”ã¨ï¼ˆæ—¥æœ¬æ™‚é–“ã§ã¯+9æ™‚é–“ï¼‰

jobs:
  process:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # å…¨ä½“ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆé€šå¸¸3åˆ†ã§å®Œäº†ï¼‰
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
          # ffmpegã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          sudo apt-get update
          sudo apt-get install -y ffmpeg
      
      - name: Create credentials directory
        run: mkdir -p credentials
      
      - name: Setup Google Service Account
        run: |
          echo "${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}" > credentials/google_service_account.json
      
      - name: Setup YouTube tokens
        run: |
          echo "${{ secrets.TOKEN_NB_PICKLE }}" | base64 -d > credentials/token_NB.pickle
          echo "${{ secrets.TOKEN_OM_PICKLE }}" | base64 -d > credentials/token_OM.pickle
          echo "${{ secrets.TOKEN_SBC_PICKLE }}" | base64 -d > credentials/token_SBC.pickle
      
      - name: Setup client secrets
        run: |
          echo "${{ secrets.CLIENT_SECRETS_JSON }}" > credentials/client_secrets.json
      
      - name: Create output directories
        run: |
          mkdir -p ad-videos
          mkdir -p outputs
          mkdir -p logs
      
      - name: Process disapproved ads
        timeout-minutes: 15  # å€‹åˆ¥ã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
        env:
          GOOGLE_APPLICATION_CREDENTIALS: credentials/google_service_account.json
          REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
        run: |
          echo "ğŸš€ Starting disapproval handler..."
          python3 production_disapproval_handler.py
          echo "âœ… Processing complete"
      
      - name: Upload logs if failed
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: error-logs
          path: |
            logs/
            *.log
          retention-days: 7