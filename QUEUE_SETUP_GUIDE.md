# キューベース広告差し替えシステム セットアップガイド

## 概要
YouTubeアップロード → スプレッドシートキュー → Google Ads差し替えの安定した自動化システム

## システムの特徴
- ✅ **安定性**: HTTP通信のタイムアウトを回避
- ✅ **可視性**: スプレッドシートで処理状況を確認可能
- ✅ **リトライ**: 自動で3回までリトライ
- ✅ **非同期**: Python側は即座に次の処理へ

## セットアップ手順

### 1. Python側の準備（完了済み）

既にファイルは更新済みです。確認のみ：

```bash
# 必要なライブラリの確認
pip install gspread google-auth
```

### 2. GAS側のセットアップ

#### 2.1 ファイルをGASプロジェクトに追加

1. Google Apps Scriptプロジェクトを開く
2. 以下のファイルを追加：
   - `キュー処理システム.js` - 新規作成してコピペ

#### 2.2 必要な既存ファイルの確認

以下のファイルが必要です（既にあるはず）：
- `広告差し替え自動化.js` - AdReplacementManagerクラス
- `審査落ちチェック.js` - DisapprovalCheckerクラス

#### 2.3 トリガーの設定

GASエディタで以下を実行：

```javascript
// 実行 → setupQueueTrigger を選択して実行
setupQueueTrigger()
```

これで5分ごとに自動実行されます。

### 3. 動作テスト

#### 3.1 Python側でテストデータ追加

```bash
cd /Users/shingo/Desktop/アプリ開発/video-merger-tool-Auto
python automation/simple_queue_manager.py
```

成功すると以下が表示されます：
```
✅ キューに追加成功: 20240112_123456_テスト広告_001
📊 キューステータス: {'pending': 1, 'processing': 0, 'completed': 0, 'failed': 0}
```

#### 3.2 スプレッドシートで確認

1. スプレッドシートを開く：
   https://docs.google.com/spreadsheets/d/1MdDrJFrzkz1N6ccgZN2mhL_SGh0a7qUKBJJ5B6gm70U/

2. 「広告差し替えキュー」シートを確認
   - 新しい行が追加されている
   - ステータスが「pending」になっている

#### 3.3 GAS側で手動実行テスト

GASエディタで：
```javascript
// 実行 → testQueueProcessing を選択
testQueueProcessing()
```

### 4. 本番運用

#### 4.1 通常の処理フロー

```python
# 通常通りad_processorを実行
python automation/ad_processor.py
```

自動的に：
1. YouTubeアップロード
2. キューに追加
3. 5分以内にGASが処理

#### 4.2 モニタリング

スプレッドシートの「広告差し替えキュー」シートで：
- **pending**: 処理待ち
- **processing**: 処理中
- **completed**: 成功
- **failed**: 失敗（リトライ上限到達）

### 5. トラブルシューティング

#### Q: キューに追加されない
A: 認証ファイル（credentials.json）の場所を確認

#### Q: GASが処理しない
A: 
1. トリガーが設定されているか確認
2. GASのログを確認（表示 → ログ）
3. DisapprovalCheckerクラスが存在するか確認

#### Q: 処理が失敗する
A: 
1. エラーメッセージを確認（K列）
2. 案件名が正しいか確認
3. 不承認広告が存在するか確認

#### Q: リトライが多い
A: Google Ads APIの認証を確認：
1. リフレッシュトークンの有効性
2. 権限の確認

### 6. 確実性の担保

このシステムは以下により確実性を担保：

1. **データ永続性**: スプレッドシートに保存
2. **ステータス管理**: 各段階を記録
3. **リトライ機能**: 最大3回まで自動リトライ
4. **エラーログ**: 失敗理由を記録
5. **処理時間記録**: パフォーマンス監視

### 7. 運用のベストプラクティス

1. **定期的な確認**
   - 1日1回はキューシートを確認
   - failed状態のタスクを調査

2. **古いデータのクリーンアップ**
   - 1週間以上前のcompletedは削除可

3. **監視**
   - Lark通知でリアルタイム把握
   - 異常なエラー率の場合は調査

## まとめ

このキューシステムにより：
- ✅ Python側はタイムアウトを気にせず高速処理
- ✅ GAS側は余裕を持って処理
- ✅ エラー時も データが残るので安心
- ✅ 手動でのリカバリも簡単